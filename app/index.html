<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datadog LLM Observability</title>
    <style>
        :root {
            /* Datadog & Dark Theme Colors */
            --bg-dark: #0f0f12;
            /* Deepest background */
            --bg-card: #1e1e24;
            /* Panel background */
            --bg-hover: #2a2a35;
            --border: #2d2d3b;
            --text-primary: #ffffff;
            --text-secondary: #8b92a5;

            /* Brand Colors */
            --dd-purple: #632ca6;
            --dd-purple-hover: #7638c2;
            --gcp-blue: #4285f4;
            --vertex-blue: #1967d2;

            /* Status Colors */
            --success: #00f29d;
            --warning: #ffab00;
            --danger: #ff4d4d;
            --info: #00a1ff;

            /* Spacing & Layout */
            --header-height: 60px;
            --footer-height: 300px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: var(--header-height);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: rgba(15, 15, 18, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 18px;
        }

        .brand svg {
            width: 24px;
            height: 24px;
            fill: var(--dd-purple);
        }

        .controls {
            display: flex;
            gap: 12px;
        }

        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--text-secondary);
        }

        .btn-primary {
            background: var(--dd-purple);
            border-color: var(--dd-purple);
        }

        .btn-primary:hover {
            background: var(--dd-purple-hover);
        }

        .btn-danger {
            color: var(--danger);
            border-color: rgba(255, 77, 77, 0.3);
        }

        .btn-danger:hover {
            background: rgba(255, 77, 77, 0.1);
        }

        .btn-warning {
            color: var(--warning);
            border-color: rgba(255, 171, 0, 0.3);
        }

        .btn-warning:hover {
            background: rgba(255, 171, 0, 0.1);
        }

        /* --- Main Content Split --- */
        .main-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 350px;
            /* Chat | Observability */
            height: calc(100vh - var(--header-height) - var(--footer-height));
            /* Explicit height constraint */
            overflow: hidden;
        }

        /* --- Chat Panel --- */
        .chat-panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            position: relative;
            height: 100%;
            overflow: hidden;
            /* Prevent children from expanding parent */
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
            /* Critical for flexbox scrolling */
            scroll-behavior: smooth;
        }

        .msg {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-user {
            align-self: flex-end;
            background: var(--bg-hover);
            border-bottom-right-radius: 2px;
            color: var(--text-primary);
        }

        .msg-bot {
            align-self: flex-start;
            background: rgba(99, 44, 166, 0.15);
            /* Tint of purple */
            border: 1px solid rgba(99, 44, 166, 0.3);
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }

        input[type="text"]:focus {
            border-color: var(--dd-purple);
        }

        /* --- Observability Panel --- */
        .obs-panel {
            background: var(--bg-card);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .obs-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
        }

        .obs-content {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 600;
            font-family: 'SF Mono', monospace;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* --- Animation Section (Bottom) --- */
        .system-flow {
            height: var(--footer-height);
            border-top: 1px solid var(--border);
            background: #15151a;
            position: relative;
            overflow: hidden;
        }

        /* Node Styles from previous animation.html (Simplified) */
        .node {
            position: absolute;
            width: 140px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            z-index: 10;
        }

        .node.active {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(0, 242, 157, 0.2);
        }

        .node-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .node-meta {
            font-size: 10px;
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* SVG Connections */
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        path {
            fill: none;
            stroke: var(--border);
            stroke-width: 2;
            stroke-dasharray: 5 5;
        }

        /* Loading Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Incident Alerts */
        .incident-alert {
            background: rgba(255, 77, 77, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>

<body>

    <header>
        <div class="brand">
            <svg viewBox="0 0 24 24">
                <path
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                    fill="#4285F4" />
                <path
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                    fill="#34A853" />
                <path
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                    fill="#FBBC05" />
                <path
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                    fill="#EA4335" />
            </svg>
            LLM Incident Commander
        </div>
        <div class="controls">
            <!-- MODE SELECTOR -->
            <button class="btn btn-primary" id="mode-normal" onclick="setMode('normal')">‚ñ∂ Normal Mode</button>
            <button class="btn" id="mode-cost" onclick="setMode('cost')">üí∞ Cost Test</button>
            <button class="btn btn-danger" id="mode-hallucination" onclick="setMode('hallucination')">‚ö†Ô∏è Hallucination
                Test</button>
        </div>
    </header>

    <!-- SAFETY BANNER (Visible in Hallucination Mode) -->
    <div id="safety-banner-top"
        style="display:none; background:#ffab0020; border-bottom:1px solid #ffab00; padding:12px; text-align:center; font-size:13px; color:#ffab00;">
        <b>‚ö†Ô∏è Controlled Hallucination Detection Demo</b> &mdash; This test injects poisoned context to validate safety
        systems.
    </div>

    <div class="main-container">
        <!-- Chat Interface -->
        <div class="chat-panel">
            <div class="chat-history" id="chat-history">
                <div class="msg msg-bot">
                    Hello! I'm your Vertex AI assistant monitored by Datadog. Ask me anything to see the observability
                    pipeline in action.
                </div>
            </div>
            <div class="chat-input-area">
                <form id="chat-form" onsubmit="handleSubmit(event)">
                    <div class="input-group">
                        <input type="text" id="user-input" placeholder="Type your query..." autocomplete="off">
                        <button type="submit" class="btn btn-primary" id="send-btn">
                            <span>Send</span>
                            <div class="spinner" id="spinner"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Observability Panel -->
        <div class="obs-panel">
            <div class="obs-header">
                <span>Request Telemetry</span>
                <span class="tag" id="status-badge" style="background:var(--success); color:#000">SAFE</span>
            </div>

            <div class="obs-content">
                <div class="metric-card">
                    <div class="metric-label">Request ID</div>
                    <div class="metric-value" style="font-size:12px; word-break:break-all;" id="val-req-id">-</div>
                </div>

                <div class="metric-card">
                    <div class="metric-row">
                        <div>
                            <div class="metric-label">Total Tokens</div>
                            <div class="metric-value" id="val-tokens">0</div>
                        </div>
                        <div style="text-align:right">
                            <div class="metric-label">Cost (USD)</div>
                            <div class="metric-value" style="color:var(--success)" id="val-cost">$0.00</div>
                        </div>
                    </div>
                    <div
                        style="margin-top:8px; display:flex; gap:4px; height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden">
                        <div id="bar-input" style="width:0%; background:var(--gcp-blue)"></div>
                        <div id="bar-output" style="width:0%; background:var(--success)"></div>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Latency</div>
                    <div class="metric-value" id="val-latency">0ms</div>
                </div>

                <!-- Quality Scores -->
                <div class="metric-card">
                    <div class="metric-label">Quality Monitors</div>
                    <div class="metric-row" style="margin-top:8px">
                        <span>Hallucination</span>
                        <span class="tag" id="val-hallucination">OK</span>
                    </div>
                    <div class="metric-row" style="margin-top:8px">
                        <span>Grounding</span>
                        <span class="tag" id="val-grounding">OK</span>
                    </div>
                </div>

                <!-- Datadog View -->
                <div class="metric-card" style="border-color:var(--dd-purple)">
                    <div class="metric-label" style="color:var(--dd-purple)">Datadog View</div>
                    <div class="metric-row" style="font-size:11px; margin-top:4px;">
                        <span>Service:</span> <span style="color:var(--text-primary)">llm-service</span>
                    </div>
                    <div class="metric-row" style="font-size:11px; margin-top:2px;">
                        <span>Env:</span> <span style="color:var(--text-primary)">prod</span>
                    </div>

                    <div id="incident-box" class="incident-alert">
                        <span>üö® <b>INCIDENT TRIGGERED</b></span>
                        <div id="incident-text">High Hallucination Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Flow Animation -->
    <div class="system-flow" id="flow-container">
        <svg id="connections"></svg>

        <!-- Nodes -->
        <div class="node" id="node-user" style="top:40px; left:40px; border-left:3px solid white">
            <div class="node-title">üë§ User</div>
            <div class="node-meta">/ask POST</div>
        </div>

        <div class="node" id="node-api" style="top:40px; left:250px; border-left:3px solid var(--gcp-blue)">
            <div class="node-title">‚ö° API Gateway</div>
            <div class="node-meta">FastAPI / Cloud Run</div>
        </div>

        <div class="node" id="node-rag" style="top:150px; left:400px; border-left:3px solid var(--vertex-blue)">
            <div class="node-title">üîç Vector Search</div>
            <div class="node-meta">Retrieved Context</div>
        </div>

        <div class="node" id="node-llm" style="top:40px; left:550px; border-left:3px solid var(--gcp-blue)">
            <div class="node-title">‚ú® Gemini 1.5</div>
            <div class="node-meta">Vertex AI</div>
        </div>

        <div class="node" id="node-judge" style="top:150px; left:700px; border-left:3px solid var(--warning)">
            <div class="node-title">‚öñÔ∏è Judge LLM</div>
            <div class="node-meta">Eval. Score</div>
        </div>

        <div class="node" id="node-dd"
            style="top:40px; left:850px; border-left:3px solid var(--dd-purple); width:200px">
            <div class="node-title">üê∂ Datadog</div>
            <div class="node-meta">Traces, Metrics, Logs</div>
        </div>
    </div>

    <script>
        // --- Logic ---
        const API_URL = "http://localhost:8000";
        let CURRENT_MODE = 'normal'; // normal, cost, hallucination

        function setMode(mode) {
            CURRENT_MODE = mode;

            // Update Buttons
            document.querySelectorAll('.controls .btn').forEach(b => {
                b.classList.remove('btn-primary', 'btn-danger');
                b.style.opacity = '0.7';
            });

            const btn = document.getElementById(`mode-${mode}`);
            btn.style.opacity = '1';

            if (mode === 'hallucination') {
                btn.classList.add('btn-danger');
                document.getElementById('safety-banner-top').style.display = 'block';
                // Pre-fill prompt
                document.getElementById('user-input').value = "Who is the CEO of NotARealCompany123?";
            } else if (mode === 'cost') {
                btn.classList.add('btn-primary'); // reused
                document.getElementById('safety-banner-top').style.display = 'none';
                document.getElementById('user-input').value = "Generate a detailed 1000-word history of the Roman Empire considering all socio-economic factors...";
            } else {
                btn.classList.add('btn-primary');
                document.getElementById('safety-banner-top').style.display = 'none';
                document.getElementById('user-input').value = "";
            }
        }

        // Init
        setMode('normal');

        async function handleSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const question = input.value.trim();
            if (!question) return;

            addMessage(question, 'user');
            input.value = '';

            // UI State
            const btn = document.getElementById('send-btn');
            const spinner = document.getElementById('spinner');
            btn.disabled = true;
            spinner.style.display = 'block';

            // Reset UI
            resetObs();
            document.getElementById('incident-box').style.display = 'none';
            document.getElementById('status-badge').innerText = "PROCESSING...";
            document.getElementById('status-badge').style.background = "#fff";

            // Start Animation
            const animPromise = animateSystemFlow();

            try {
                // Call Backend
                const payload = {
                    question: question,
                    temperature: 0.2,
                    test_mode: CURRENT_MODE // 'hallucination', 'cost', or 'normal'
                };

                const response = await fetch(`${API_URL}/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail?.message || errData.detail || "Request failed");
                }

                const data = await response.json();

                // Wait for animation
                await animPromise;

                // Handle BLOCKED response
                if (data.status === 'blocked') {
                    addMessage(`üö´ ${data.message}`, 'bot');
                    document.getElementById('status-badge').innerText = "BLOCKED BY SAFETY";
                    document.getElementById('status-badge').style.background = "var(--danger)";

                    triggerIncident("Hallucination Attempt Blocked");
                } else {
                    addMessage(data.answer, 'bot');
                    document.getElementById('status-badge').innerText = "SAFE";
                    document.getElementById('status-badge').style.background = "var(--success)";
                }

                updateObservability(data);
                await animateDataIngest();

            } catch (err) {
                addMessage(`Error: ${err.message}`, 'bot');
                console.error(err);
            } finally {
                btn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function triggerIncident(msg) {
            const box = document.getElementById('incident-box');
            document.getElementById('incident-text').innerText = msg;
            box.style.display = 'flex';

            // Also animate Datadog node as red
            const ddNode = document.getElementById('node-dd');
            ddNode.style.borderColor = 'var(--danger)';
            ddNode.style.boxShadow = '0 0 20px rgba(255, 77, 77, 0.4)';
            setTimeout(() => {
                ddNode.style.borderColor = 'var(--dd-purple)';
                ddNode.style.boxShadow = 'none';
            }, 3000);
        }

        function addMessage(text, type) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `msg msg-${type}`;
            div.innerText = text;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        function updateObservability(data) {
            // Basic Metrics
            document.getElementById('val-req-id').innerText = data.request_id || "N/A";
            document.getElementById('val-tokens').innerText = data.tokens.total;
            document.getElementById('val-cost').innerText = `$${data.cost_usd.toFixed(6)}`;
            document.getElementById('val-latency').innerText = `${data.latency_ms}ms`;

            // Bars
            const total = data.tokens.total;
            const inputPct = (data.tokens.input / total) * 100;
            const outputPct = (data.tokens.output / total) * 100;
            document.getElementById('bar-input').style.width = `${inputPct}%`;
            document.getElementById('bar-output').style.width = `${outputPct}%`;

            // Scores / Monitors
            const hScore = data.hallucination_score || 0;
            const hElem = document.getElementById('val-hallucination');

            if (hScore > 0.6) { // Bad score threshold
                hElem.innerText = "CRITICAL";
                hElem.style.background = "var(--danger)";
                triggerIncident("High Hallucination Score");
            } else {
                hElem.innerText = "OK";
                hElem.style.background = "var(--success)";
            }
        }

        function resetObs() {
            document.getElementById('val-tokens').innerText = "0";
            document.getElementById('val-cost').innerText = "$0.00";
            document.getElementById('val-latency').innerText = "0ms";
            document.getElementById('val-hallucination').innerText = "OK";
            document.getElementById('val-hallucination').style.background = "rgba(255,255,255,0.1)";
        }

        // --- Animation Logic ---
        async function animateSystemFlow() {
            // Sequence: User -> API -> RAG -> LLM
            await animatePath('node-user', 'node-api', 500);
            await animatePath('node-api', 'node-llm', 500);

            // Fork RAG
            animatePath('node-api', 'node-rag', 400);
        }

        async function animateDataIngest() {
            // Sequence: LLM -> Judge & Datadog
            await animatePath('node-llm', 'node-judge', 600);
            await animatePath('node-llm', 'node-dd', 400);
            await animatePath('node-judge', 'node-dd', 400);
        }

        function animatePath(fromId, toId, duration) {
            return new Promise(resolve => {
                const svg = document.getElementById('connections');
                const from = document.getElementById(fromId).getBoundingClientRect();
                const to = document.getElementById(toId).getBoundingClientRect();
                const container = document.getElementById('flow-container').getBoundingClientRect();

                // Calc coordinates relative to container
                const x1 = from.left + from.width / 2 - container.left;
                const y1 = from.top + from.height / 2 - container.top;
                const x2 = to.left + to.width / 2 - container.left;
                const y2 = to.top + to.height / 2 - container.top;

                // Draw Line
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const d = `M ${x1} ${y1} C ${(x1 + x2) / 2} ${y1}, ${(x1 + x2) / 2} ${y2}, ${x2} ${y2}`;
                path.setAttribute("d", d);
                svg.appendChild(path);

                // Highlight Nodes
                document.getElementById(fromId).classList.add('active');

                // Animate Particle
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("r", "4");
                circle.setAttribute("fill", "#fff");
                svg.appendChild(circle);

                const start = performance.now();

                function step(time) {
                    const progress = Math.min((time - start) / duration, 1);
                    const point = path.getPointAtLength(progress * path.getTotalLength());
                    circle.setAttribute("cx", point.x);
                    circle.setAttribute("cy", point.y);

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        document.getElementById(fromId).classList.remove('active');
                        document.getElementById(toId).classList.add('active');
                        setTimeout(() => document.getElementById(toId).classList.remove('active'), 300);
                        // Cleanup
                        svg.removeChild(circle);
                        // Keep path for a bit then fade? For now keep it simple
                        // svg.removeChild(path); 
                        resolve();
                    }
                }
                requestAnimationFrame(step);
            });
        }

        // Initial Connections Draw
        window.onload = () => {
            // Draw static lines if needed, or just let animation handle it.
            // For a cleaner look, we let animation draw them on demand or draw hidden lines.
            // Let's just draw faint lines for structure.
            drawConnection('node-user', 'node-api');
            drawConnection('node-api', 'node-rag');
            drawConnection('node-api', 'node-llm');
            drawConnection('node-llm', 'node-judge');
            drawConnection('node-llm', 'node-dd');
            drawConnection('node-judge', 'node-dd');
        };

        function drawConnection(fromId, toId) {
            const svg = document.getElementById('connections');
            const from = document.getElementById(fromId).getBoundingClientRect();
            const to = document.getElementById(toId).getBoundingClientRect();
            const container = document.getElementById('flow-container').getBoundingClientRect();

            const x1 = from.left + from.width / 2 - container.left;
            const y1 = from.top + from.height / 2 - container.top;
            const x2 = to.left + to.width / 2 - container.left;
            const y2 = to.top + to.height / 2 - container.top;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const d = `M ${x1} ${y1} C ${(x1 + x2) / 2} ${y1}, ${(x1 + x2) / 2} ${y2}, ${x2} ${y2}`;
            path.setAttribute("d", d);
            path.style.opacity = "0.2";
            svg.appendChild(path);
        }
    </script>
</body>

</html>